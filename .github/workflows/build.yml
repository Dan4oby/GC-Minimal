name: Build pack

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Download Pakku (pinned version)
        run: |
          PAKKU_VERSION="1.3.3"
          curl -L -o pakku.jar "https://github.com/juraj-hrivnak/Pakku/releases/download/v${PAKKU_VERSION}/pakku.jar"
          java -jar pakku.jar --version

      - name: Configure CurseForge credentials
        run: |
          java -jar pakku.jar credentials set --cf-api-key '${{ secrets.CF_API_KEY }}'

      - name: Fetch mods
        run: |
          java -jar pakku.jar fetch

      - name: Export multiplatform zip
        run: |
          java -jar pakku.jar export

      - name: Read pack name from pakku.json
        id: packver
        run: |
          PACK_NAME=$(jq -r '.name' pakku.json)
          echo "PACK_NAME=$PACK_NAME" >> $GITHUB_ENV
          echo "name=$PACK_NAME" >> $GITHUB_OUTPUT
          echo "Pack name: $PACK_NAME"
      
      - name: Read pack version from pakku.json
        id: packver
        run: |
          PACK_VERSION=$(jq -r '.version' pakku.json)
          echo "PACK_VERSION=$PACK_VERSION" >> $GITHUB_ENV
          echo "version=$PACK_VERSION" >> $GITHUB_OUTPUT
          echo "Pack version: $PACK_VERSION"

      - name: Upload CurseForge build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.packver.outputs.name }}-${{ steps.packver.outputs.version }}-CURSEFORGE
          path: build/curseforge/*.zip

      - name: Upload Modrinth build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.packver.outputs.name }}-${{ steps.packver.outputs.version }}-MODRINTH
          path: build/modrinth/*.mrpack